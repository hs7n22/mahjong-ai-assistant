# 📘 开发者日志（Developer Log）

🗓 时间范围：2025 年 4 月 22 日 - 2025 年 04 月 23 日  
📦 模块：Flutter 前端登录注册系统（集成 Supabase）

---

## 🔹 2025 年 4 月 22 日（Day 1）

### ✅ 初始化 Supabase 集成

- 完成 Supabase 项目的创建与 Flutter SDK 初始化
- 成功配置 `supabaseUrl` 与 `anonKey`
- 将 `Supabase.initialize()` 封装至 `supabase_config.dart`

### ✅ 登录 UI 构建

- 创建 `AuthPage`，实现邮箱+密码注册/登录界面
- 接入 `TextField + ElevatedButton` 表单组件
- 使用 `Logger` 替代 `print()`，记录认证过程中的关键日志

### 🐞 问题 1：点击登录按钮无反应

- **原因**：`onPressed: () => signOut` 没有执行函数
- ✅ 解决方案：改为 `onPressed: signOut` 或 `() => signOut()`

### 🐞 问题 2：每次注册同一账号都提示注册成功

- **原因**：Supabase 默认开启邮箱验证机制，未验证状态下不会报错
- ✅ 解决方案：识别 `user.emailConfirmedAt == null` 并给出用户提示

---

## 🔹 2025 年 4 月 23 日（Day 2）

### ✅ 完善注册后邮箱验证逻辑

- 注册成功后不再直接跳转主页，而是检查邮箱是否验证
- 使用 `user.emailConfirmedAt` 字段判断验证状态

### ✅ 添加邮箱验证提示

- 未验证时弹出提示：“请前往邮箱完成验证后再登录”
- 注册成功提示：“注册成功，请验证邮箱”

### ✅ 添加刷新状态按钮

- 在 `AppBar` 添加刷新按钮 `IconButton(refresh)`
- 点击后使用 `Supabase.auth.refreshSession()` 重新拉取用户状态
- 若邮箱验证成功，立即跳转到主页
- 若邮箱仍未验证，提示“邮箱未验证，请完成验证后再试”

### 🐞 问题 3：点击刷新按钮没有任何反馈

- **原因**：使用 `auth.currentUser` 获取的是本地缓存，不会自动刷新邮箱状态
- ✅ 解决方案：使用 `auth.refreshSession()` 获取服务器最新验证状态

### 🐞 问题 4：邮箱验证链接打不开

- **原因**：Supabase 默认验证邮件跳转地址为 `localhost`，但在手机上打开，无法访问开发机 localhost
- ✅ 解决方案：将验证链接复制到 mac 上打开，即可成功完成验证

---

## ✅ 当前成果总结

| 功能                        | 状态 |
| --------------------------- | ---- |
| ✅ Supabase SDK 初始化      | 完成 |
| ✅ 登录/注册表单            | 完成 |
| ✅ 注册后强制邮箱验证       | 完成 |
| ✅ 刷新按钮手动检查验证状态 | 完成 |
| ✅ 日志系统记录认证事件     | 完成 |
| ✅ 登录状态判断与页面跳转   | 完成 |
| ✅ 登出功能（含错误处理）   | 完成 |

---

## 📦 下一步建议（可选）

- 🔄 登录成功后监听 `onAuthStateChange` 实现自动跳转
- 🎨 登录页 UI 美化（加入 loading、进度反馈）
- 🖼 添加图片上传页（用于麻将牌识别）
- 🧭 使用 `GoRouter` 实现多页面路由统一管理

## ✅ 补充追加

• OPTIONS 400 问题的解决（CORS 与跨域预检）
• Invalid audience 的 Supabase JWT 鉴权修复
• Flutter 中中文乱码处理
• log.info() 日志打印和终端输出验证
• 整个验证链条的最终闭环 ✅

🧾 开发者日志：2025-04-23（第三章 · Part 1 完成）

✅ 本阶段任务完成：
• 🖼️ 实现了 Flutter Web 端选择图片上传功能
• 🔐 上传请求自动携带 Supabase Token，完成前后端身份识别
• 💾 FastAPI 成功接收 multipart/form-data，保存上传图片至本地 uploads/ 目录
• 📄 上传文件名自动包含用户 ID，便于权限管理与追溯
• 📬 前端反馈上传结果状态码 + JSON 内容
• ✅ 前后端全链路运行无误，项目进度大幅推进
